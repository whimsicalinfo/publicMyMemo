# 数理最適化・アルゴリズム完全網羅ハンドブック

これまでの対話で解説したすべての理論、アルゴリズム、実装テクニックを網羅した資料です。

---

## 1. 基礎理論・概念

| 用語 | 説明 |
| :--- | :--- |
| **漸化式** | 「今日の状態は昨日の状態で決まる」というルール。動的計画法の基礎。 |
| **動的計画法 (DP)** | 漸化式の計算結果を「表（メモ）」に記録し、再利用して効率的に解く手法。 |
| **三角不等式** | 「寄り道するより直行したほうが早い（または等しい）」という距離のルール ($d_{ac} \le d_{ab} + d_{bc}$)。これが成り立たないと近似解法が使えない場合がある。 |
| **部分構造最適性** | 「最短ルートの一部を切り取っても、それはやはり最短ルートである」という性質。 |
| **負閉路 (Negative Cycle)** | 通るとコストが減る（得をする）無限ループ。これが存在すると最短路問題は解けない（が、最小費用流では利用する）。 |
| **双対性 (Duality)** | 「裏の問題（双対問題）」を考えることで、元の問題の正解の範囲（下界など）を知る理論。 |

---

## 2. 最短路問題 (Shortest Path)
地図上の2点間の最短ルートを求める問題。

| アルゴリズム | 特徴・仕組み | 弱点・制約 |
| :--- | :--- | :--- |
| **ラベリング法** | すべての最短路アルゴリズムの親玉。「近道が見つかる限り更新し続ける」という枠組み。 | これだけでは具体的でない。 |
| **ダイクストラ法** | **確定拡張型**。一番近い未確定ノードを順次「確定」させていく。爆速。 | **負の辺**があると使えない。 |
| **ベルマン・フォード法** | **全辺総点検型**。すべての辺を何度もチェックして更新する。 | 計算は遅いが、**負の辺**があってもOK。負閉路も検出可能。 |
| **フロイド・ウォーシャル法** | **全点対型**。あらゆる都市間の距離を一気に計算する(DP)。 | 都市数の3乗で計算量が増えるため、大規模データには不向き。 |

---

## 3. ネットワークフロー問題
パイプラインや交通網の「流れ」を最適化する問題。

### 3.1 最大流問題 (Max Flow)
スタート($s$)からゴール($t$)まで、容量制限を守って最大どれだけ流せるか？

* **フォード・ファルカーソン法 (増加路法):** 「流せるルート」を探して流す。**残余ネットワーク**（逆流可能な仮想ルート）を使って修正しながら進む。
* **エドモンズ・カープ法:** ルート探しに「幅優先探索（最短パス）」を使うことで、計算爆発を防ぐ改良版。
* **最大流最小カット定理:** 「最大流量」は、ネットワークのボトルネックである「最小カット（断面）の容量」と一致する。

### 3.2 最小費用流問題 (Min Cost Flow)
需要と供給を満たしつつ、輸送コストを最小にする。

* **負閉路消去法:** とりあえず流した後、残余ネットワーク上で「コストが減るループ（負閉路）」を見つけてぐるぐる回し、コストを下げる。
* **最短路繰り返し法:** **ポテンシャル**（高さの概念）を導入し、「被約費用（高さ考慮済みコスト）」を使うことで、ダイクストラ法を適用可能にして高速化した手法。

### 3.3 応用例
* **2部グラフの最大マッチング:** 仕事と人を最大数ペアリングする。「最大流問題」に変換して解ける。
* **画像分割:** 画像の前景・背景を切り抜く。「最小カット問題」に変換して解ける。

---

## 4. 厳密解法（線形・整数計画問題）
「絶対に正しい答え」を出すための手法。計算時間がかかる。

* **単体法:** 線形計画法の基本。多面体の頂点を移動して最適解を探す。
* **分枝限定法:** 整数解を出すために、解空間を「$x \le 2$」と「$x \ge 3$」のように分割（分枝）し、見込みのない枝を切り捨てる（限定）。
* **切除平面法:** 小数の解が出たら、その解だけを禁止する「新しい不等式（壁）」を追加して削り取る。
* **分枝カット法:** 上記2つを組み合わせた、現代の商用ソルバー（Gurobi等）の標準エンジン。

---

## 5. 近似アルゴリズム（Approximation Algorithms）
NP困難な問題に対し、短時間で「保証付きのそこそこ良い解」を出す手法。

### 5.1 ビンパッキング問題（箱詰め）
* **NF法 (Next-Fit):** 前の箱に戻らず、次々と新しい箱に入れる。計算は早いが精度は低い。
* **FF法 (First-Fit):** 毎回、先頭の箱から順に「入る場所」を探す。
* **FFD法 (First-Fit Decreasing):** 荷物を**大きい順**に並べてからFF法を行う。実用上はこれが最強かつ簡単。

### 5.2 ナップサック問題
* **貪欲法:** コスパ（価値/重さ）順に詰める。最大価値の品1つと比較することで、精度保証($1/2$)が付く。
* **FPTAS (近似スキーム):** 価値の数字を荒く丸めて（スケーリング）、高速にDPを行う。精度と速度のトレードオフを調整可能。

### 5.3 最大カット問題
* **乱択法:** コイン投げでチーム分けする。期待値で50%のスコアが出る。
* **貪欲法:** 頂点を1つずつ、「カット数が増える方のチーム」に入れていく。脱乱択化。
* **局所探索法:** 「寝返ったほうが得な人」がいなくなるまで移動させる。

### 5.4 巡回セールスマン問題 (TSP)
* **木二重化法:** 最小全域木を作って往復（2倍）させ、ショートカットする。2倍以内の誤差保証。
* **クリストフィデス法:** 最小全域木に「奇数次数のマッチング」を足して一筆書きにする。1.5倍以内の誤差保証。
* **最近追加法:** 小さなループから始め、一番近い都市を徐々に挿入して広げていく。

### 5.5 頂点被覆問題（監視カメラ）
* **貪欲法:** コスパが良い（未カバー道路が多い）場所から置く。精度保証は弱め($\log n$)。
* **主双対法:** 「道路（辺）」が価格を釣り上げ、「交差点（頂点）」がコストに見合ったら設置する市場原理シミュレーション。2倍保証。
* **丸め法:** 線形計画緩和（0.5台設置とか）を解き、0.5以上なら1、未満なら0にする。2倍保証。

---

## 6. 局所探索法とその周辺技術
今の解を少しずつ改良する山登り的な手法。

### 6.1 基本動作
* **近傍 (Neighborhood):** 「解の変形」の定義。TSPなら2-opt（辺のつなぎ替え）、挿入、交換など。
* **探索:** 近傍の中で「今より良い解」があれば移動する。

### 6.2 高速化の実装テクニック
* **差分計算 (Delta Eval):** 全体を再計算せず、変更箇所（減った距離・増えた距離）だけ計算する。
* **近傍リスト:** 遠く離れた都市との交換は最初からチェックしない。
* **Don't Look Bit (DLB):** 「昨日チェックしてダメだった場所」にはフラグを立て、周辺に変化がない限り無視する。

### 6.3 制約の扱い
* **ペナルティ法:** ルール違反（容量オーバー等）を「即アウト」にせず、「罰金」としてコストに上乗せして探索を継続させる。

---

## 7. メタヒューリスティクス
局所探索法が陥る「局所最適解（低い山の頂上）」から脱出し、真の正解を目指す高度な戦略。

### 7.1 基本戦略系
* **多スタート局所探索法 (MLS):** 毎回場所を変えて、ゼロから局所探索を繰り返す。
* **GRASP:** 初期解を作る際、「完全ランダム」ではなく「貪欲法＋ランダム（上位候補から抽選）」で質の良いスタート地点を作る。

### 7.2 変形・学習系
* **反復局所探索 (ILS):** 局所解にたどり着いたら、**摂動**（ジャンプ、Double Bridge等）を加えて少し離れた場所から再開する。
* **可変近傍探索 (VNS):** 小さな変形でダメなら、徐々に変形を大きく（ギアチェンジ）していく。
* **誘導局所探索 (GLS):** 行き詰まったら、その解が持つ「悪い特徴（長い辺など）」に**ペナルティ（罰金）**を加算し、評価関数（地形）そのものを変形させて解を押し出す。

### 7.3 生物・物理模倣系
* **アニーリング法 (SA):** 最初は確率的に「改悪」も許容し（高温）、徐々に許容しなくなる（冷却）。
    * **閾値受理法 (TA):** 確率計算をせず、「改悪が閾値以内ならOK」とする簡易版。
    * **大洪水法 (GDA):** 「水位（基準値）」より高ければどこへ移動してもOK。水位を徐々に上げて追い込む。
* **タブー探索 (Tabu Search):** 過去の移動を「タブーリスト（記憶）」に入れ、元に戻る動きを禁止して強制的に脱出させる。
* **遺伝的アルゴリズム (GA):** 集団で探索。**交叉**（親の特徴を混ぜる）と**突然変異**で進化させる。
    * **ミームアルゴリズム:** GAで生まれた子供に、さらに局所探索（教育）を施して強化するハイブリッド手法。

---

## 8. ラグランジュヒューリスティクス
非常に難しい制約付き問題を解くための上級テクニック。

1.  **ラグランジュ緩和:** 守るのが難しい制約を取り払い、代わりに「違反時の罰金（ラグランジュ乗数）」を目的関数に加える。
2.  **劣勾配法:** 罰金の価格を調整して、最適なバランス（良い下界）を探る。
3.  **ヒューリスティクス:** 緩和問題の解（ほぼ正解に近いが、少しルール違反している状態）をベースに、貪欲法などで微修正して実行可能解を作る。

---

## 9. ツール・ソルバー対応表

| ジャンル | 推奨ツール/ソルバー | 補足 |
| :--- | :--- | :--- |
| **線形・整数計画** | **Gurobi**, **CPLEX**, CBC, SCIP | 数式で記述できる問題（生産計画、シフト作成）に最強。商用は圧倒的に速い。 |
| **グラフ・ネットワーク** | **NetworkX** (Python) | 最短路、最大流などを手軽に計算するライブラリ。 |
| **経路・配送 (VRP)** | **Google OR-Tools** | 配送計画に特化したエンジンを持つ。中身はメタヒューリスティクス。 |
| **汎用・大規模** | **LocalSolver** | 厳密解にこだわらず、超高速に近似解を出す商用ソルバー。 |
| **自作アルゴリズム** | Python (NumPy/Numba) | 局所探索やGAを自作する場合。Pythonそのままだと遅いのでNumba等で高速化する。 |
