# 数理最適化・アルゴリズム総合ハンドブック（完全版）

本資料は、これまでの対話で取り上げた数理最適化の理論、アルゴリズム、実装技術、および実務（特に物流・交通分野）への応用を網羅的にまとめたものです。

---

## 第1章：数理最適化の基礎と分類

### 1.1 問題の分類と難易度
現実の問題をコンピュータで解く際、その問題がどのタイプに属するかを見極めることが最重要です。

| 問題の種類 | 定義 | 難易度・特徴 | 代表的な用途 |
| :--- | :--- | :--- | :--- |
| **線形計画問題 (LP)** | 目的関数も制約条件もすべて「1次式（直線）」で表される。変数は連続値。 | **易しい (P)**<br>数万変数の規模でも瞬時に解ける。 | 原料の配合最適化、工場の生産量配分 |
| **整数計画問題 (MIP/IP)** | LPに加え、変数が「整数」に限定される（0か1、個数など）。 | **難しい (NP困難)**<br>変数が数百個でも、解くのに数億年かかる場合がある。 | シフト作成、配送ルート（行く/行かない）、拠点配置 |
| **ネットワークフロー問題** | 「点（ノード）」と「線（エッジ）」のグラフ上で、モノの流れを扱う。 | **易しいものが多い**<br>LPの特殊形だが、専用アルゴリズムでさらに高速に解ける。 | 最短経路、最大流、最小費用流 |
| **非線形計画問題 (NLP)** | 式に2乗や曲線、三角関数などが含まれる。 | **非常に難しい**<br>局所解（偽の頂上）が無数にあり、厳密解の保証が困難。 | 物理シミュレーション、金融工学、化学プラント制御 |

### 1.2 重要な基礎概念
アルゴリズムを理解するための共通言語です。

* **漸化式 (Recurrence Relation):**
    * 「明日の状態は、今日までの結果で決まる」という関係式。動的計画法の核となる概念。
* **動的計画法 (DP):**
    * コンセプト: 「困難は分割せよ」。
    * 手法: 漸化式に基づいて計算した結果を「表（メモ）」に記録し、再利用することで計算爆発を防ぐ。
* **三角不等式 (Triangle Inequality):**
    * $d_{ac} \le d_{ab} + d_{bc}$ （直行する距離は、寄り道する距離より短いか等しい）。
    * 重要性: これが成り立つ世界（メトリック空間）でないと、多くの近似アルゴリズムは機能しない。
* **双対性 (Duality):**
    * ある問題（主問題）に対し、裏返しの関係にある「双対問題」を考えること。
    * 用途: 「これ以上コストは下がらない」という下界（Lower Bound）を知るために使う。
* **緩和 (Relaxation):**
    * 厳しい条件（例：整数じゃなきゃダメ）を緩める（例：小数でもいいよ）こと。問題を簡単にしてヒントを得るために使う。

---

## 第2章：最短路問題 (Shortest Path Problems)
カーナビや乗換案内の基礎となる技術群です。

### 2.1 基礎：ラベリング法 (Labeling Method)
* **概要:** 最短路アルゴリズムの「親玉（フレームワーク）」。
* **仕組み:**
    1.  暫定的な距離を$\infty$にしておく。
    2.  「もっと近道がある」と判明するたびに距離ラベルを更新（Relax）する。
    3.  更新が止まるまで繰り返す。
* **位置づけ:** ダイクストラ法なども、この手法の一種（派生形）である。

### 2.2 ダイクストラ法 (Dijkstra's Algorithm)
* **キャッチコピー:** 「確定領土の拡大」
* **アルゴリズム:**
    1.  スタートから一番近い「未確定ノード」を選ぶ。
    2.  そのノードへの最短路を「確定」とする。
    3.  そのノードを踏み台にして、隣接ノードの距離を更新する。
* **強み:** 計算が非常に高速（計算量は辺の数にほぼ比例）。
* **弱点:** **「負の辺（コストが減る道）」があると使えない。**
* **物流での用途:** 道路ネットワーク上の移動時間計算。

### 2.3 ベルマン・フォード法 (Bellman-Ford Algorithm)
* **キャッチコピー:** 「慎重な総点検」
* **アルゴリズム:**
    * すべての辺を、頂点の数だけ繰り返しチェックして更新する。
    * **高速化（ラベル修正法）:** 更新があった場所の周辺だけを再チェックするキュー方式が実用的。
* **強み:** **「負の辺」があっても正しく動作する。**
* **特殊機能:** **「負閉路（Negative Cycle）」**の検出。
    * いくら回ってもコストが減り続ける無限ループがある場合、「解なし」と警告を出せる。

### 2.4 フロイド・ウォーシャル法 (Floyd-Warshall Algorithm)
* **キャッチコピー:** 「全知全能の表作成」
* **アルゴリズム:** 3重ループを回して、**「すべての都市間」**の最短距離を一気に求める動的計画法。
* **弱点:** 計算量が $O(N^3)$ と重いため、都市数が数百〜数千を超えると使えない。

---

## 第3章：ネットワークフロー問題
パイプラインや交通網の「容量」と「コスト」を扱う問題です。

### 3.1 最大流問題 (Maximum Flow Problem)
* **目的:** スタート($s$)からゴール($t$)まで、パイプの容量制限を守りつつ、最大で毎分何リットル流せるか？
* **重要概念:**
    * **残余ネットワーク:** 「A→Bに10流した」＝「B→Aに10押し戻せる」と考え、キャンセル可能なルートを地図に残す考え方。
* **アルゴリズム:**
    * **フォード・ファルカーソン法（増加路法）:** 流せるルート（増加路）がある限り流し続ける。
    * **エドモンズ・カープ法:** ルート探しに「幅優先探索（最短パス）」を使うことで、非効率なルート選択を防ぐ改良版。
* **最大流最小カット定理:**
    * 「最大流量」は、ネットワークを分断する最も狭い断面（ボトルネック）である**「最小カットの容量」と等しい**。

### 3.2 最小費用流問題 (Minimum Cost Flow Problem)
* **目的:** 各地の需要と供給を満たしつつ、輸送コストの合計を最小にする。
* **アルゴリズム:**
    * **負閉路消去法:**
        1.  とりあえず需要を満たすルートで流す（コスト度外視）。
        2.  残余ネットワーク上で**「コストがマイナスになるループ（負閉路）」**を探す。
        3.  そのループに沿ってフローを回し、コストを削減する。
    * **最短路繰り返し法 (Successive Shortest Path):**
        * **ポテンシャル ($y_v$):** 各地点の「高さ（標高）」のような概念を導入。
        * **被約費用:** 「実際のコスト」に「高さの差」を加味したコスト。これを使うと、常にコストが正（ダイクストラ法が使える状態）になり、高速に計算できる。

### 3.3 応用：これが何に使えるか？
* **2部グラフの最大マッチング:**
    * 「仕事」と「人」のペアリング最大化。最大流問題に変換して解ける。
* **画像分割 (Image Segmentation):**
    * 画像の前景と背景を切り抜く。「画素」をノードとみなし、境界線のコストを最小にする**最小カット問題**として解く。

---

## 第4章：厳密解法（線形・整数計画法）
「絶対に正しい答え」を出すための数学的アプローチです。

### 4.1 単体法 (Simplex Method)
* **概要:** 線形計画法(LP)の基本アルゴリズム。
* **イメージ:** 多面体の「頂点」を次々と渡り歩き、一番高い（または低い）頂点を探す。

### 4.2 分枝限定法 (Branch and Bound)
* **概要:** 整数計画問題の基本戦略。
* **イメージ:** 「パラレルワールド作戦」。
    * **分枝 (Branch):** 答えが「2.5」になったら、「2以下の世界」と「3以上の世界」に問題を分割する。
    * **限定 (Bound):** 分割した先で、「どう頑張っても暫定トップの利益（100円）を超えない（上限90円）」と分かったら、その枝（世界）を切り捨てる。

### 4.3 切除平面法 (Cutting Plane Method)
* **イメージ:** 「彫刻刀で削り出し」。
* **手法:** 小数の答え（2.5など）が出たら、その答えだけを禁止する**「有効不等式（カット）」**を追加して、実行可能領域を削り取る。

### 4.4 分枝カット法 (Branch and Cut)
* **概要:** 現代のソルバー（Gurobi, CPLEX等）の中身。
* **手法:** 「切除平面法」で可能な限り形を綺麗にしてから、「分枝限定法」で分割するコンボ技。

### 4.5 ソルバー利用の実務
* **モデリング:** 人間が行う作業。問題を `minimize cost` `subject to x + y <= 10` といった数式コードに翻訳すること。
* **LP/MPS形式:** ソルバーに数式を渡すための標準ファイルフォーマット。

---

## 第5章：近似アルゴリズム
NP困難な問題に対し、計算時間を優先して「保証付きの妥協解」を出す手法です。

### 5.1 ビンパッキング問題（箱詰め）
* **NF法 (Next-Fit):** 前の箱を閉じて、次へ進む。振り返らない。精度悪い。
* **FF法 (First-Fit):** 毎回、1番目の箱から順に「入る場所」を探す。
* **FFD法 (First-Fit Decreasing):**
    * **手順:** 荷物を**「大きい順」**に並べ替えてからFF法を行う。
    * **性能:** 非常に高性能。実務ではほぼこれが正解。
* **対称性の排除:** ソルバーで厳密解を出す場合、「箱Aと箱Bは同じもの」と認識させて探索を減らす工夫が必要。

### 5.2 ナップサック問題
* **貪欲法:** 「重さあたりの価値（コスパ）」が高い順に詰める。
    * 補正: 「貪欲解」と「一番高い品物1個」を比べて良い方を採用すれば、最適値の1/2以上が保証される。
* **FPTAS (完全多項式時間近似スキーム):**
    * **手法:** 価値の数字を「12345円 → 123（百円単位）」のように荒く丸める（スケーリング）。
    * **効果:** 数字が小さくなるので動的計画法(DP)が爆速になる。精度と速度のトレードオフを自由に調整可能。

### 5.3 最大カット問題
グラフを2チームに分け、またぐ辺の重みを最大化する。
* **乱択法:** コイン投げで決める。期待値で50%の辺をカットできる。
* **貪欲法:** 頂点を1つずつ、「カット数が増える方のチーム」に入れていく。
* **局所探索法:** 「寝返ったほうが得な人」がいなくなるまで移動させる。

### 5.4 巡回セールスマン問題 (TSP)
* **前提:** 三角不等式が成り立つ（ワープがない）世界であること。
* **木二重化法:** 最小全域木を作り、すべての道を往復（2倍）させて一筆書きし、重複をショートカットする。誤差2倍保証。
* **クリストフィデス法:**
    * 最小全域木の中で「奇数次数の頂点」だけをマッチングさせて偶数にする。
    * 誤差1.5倍保証。実用的な近似解法の最高峰。
* **最近追加法:** 小さなループから始め、一番近い都市を徐々に挿入して広げていく。

### 5.5 頂点被覆問題（監視カメラ配置）
* **主双対法 (Primal-Dual):**
    * 「道路」が価格を釣り上げ、「交差点」がコストに見合ったら設置する市場原理シミュレーション。誤差2倍保証。
* **丸め法:**
    * 線形計画緩和で解く（例: A地点に0.7台）。
    * 0.5以上の場所には1台、未満は0台と決める。誤差2倍保証。

---

## 第6章：局所探索法と高速化技術
「今ある答え」を改良し続ける、実務最適化のエンジン部分です。

### 6.1 基本構造
* **近傍 (Neighborhood):** 解をどう変形するか？
    * **TSPの例:** 2-opt（辺のクロスを解く）、Or-opt（ブロック移動）、挿入、交換。
* **探索:** 近傍の中に「今より良い解」があれば移動する。

### 6.2 高速化テクニック（プロの技）
* **差分計算 (Delta Evaluation):**
    * ルート全体の距離を再計算せず、「AとBを入れ替えた時の差額（減る距離 - 増える距離）」だけを計算する。数千倍速くなる。
* **近傍リスト (Neighbor List):**
    * 「東京」の交換候補として「ブラジル」をチェックしない。近くの都市上位20個程度だけをリストアップしておく。
* **Don't Look Bit (DLB):**
    * 「昨日チェックして改善案がなかった場所」にフラグを立てる。周辺に変化がない限り、再チェックせずスルーする。

### 6.3 制約の扱い
* **ペナルティ法:**
    * 容量オーバーなどのルール違反を「禁止」にせず、「罰金（コスト加算）」として許容する。これにより、壁を乗り越えてより良い解へ移動できる。

---

## 第7章：メタヒューリスティクス
局所探索法が陥る「局所最適解（低い山の頂上）」から脱出し、真の正解を目指す戦略。

### 7.1 初期解生成の工夫
* **多スタート局所探索法 (MLS):** 毎回場所を変えて、ゼロから局所探索を繰り返す（ヘリコプター作戦）。
* **GRASP:**
    * 初期解を作る際、「完全な貪欲法（毎回ベストを選ぶ）」だと毎回同じになる。
    * 「ベスト3の中からランダムに選ぶ」ことで、質の良さと多様性を両立させる。

### 7.2 解を変形する戦略（Iterative系）
* **反復局所探索 (ILS):**
    * 行き詰まったら、現在の解に**「摂動（Perturbation）」**を加える。
    * **Double Bridge:** TSPにおいて、4本の辺を一度に入れ替える「局所探索では起き得ない大きなジャンプ」を行い、隣の谷へ移動する。
* **可変近傍探索 (VNS):**
    * 「ギアチェンジ」作戦。小さな変形で改善しなければ、徐々に変形の規模（近傍）を大きくしていく。

### 7.3 自然現象を模した戦略
* **アニーリング法 (SA):**
    * **焼きなまし法**。最初は「改悪」も確率で許容し（高温）、徐々に許容しなくなる（冷却）。
    * パラメータ「温度」の調整が肝。
* **閾値受理法 (Threshold Accepting):**
    * SAの簡易版。確率計算をせず、「改悪が閾値（例: 100円の損）以内ならOK」とする。計算が速い。
* **大洪水法 (Great Deluge):**
    * 「水位」という基準を設ける。「水位より高い位置（良いスコア）」なら、改悪でも移動してOK。水位を徐々に上げて追い込む。
* **遺伝的アルゴリズム (GA):**
    * 集団で探索。
    * **交叉 (Crossover):** 親の特徴を混ぜる。TSPでは「順序交叉（順序を守りつつ混ぜる）」などが必須。
    * **ミームアルゴリズム:** GAで生まれた子供に、さらに局所探索（教育）を施して強化する最強クラスの手法。
* **タブー探索 (Tabu Search):**
    * **記憶**に基づく戦略。
    * 「さっき動かした要素」をタブーリスト（禁止リスト）に入れ、元に戻るのを防ぐことで強制的に未探索領域へ進ませる。

### 7.4 評価関数を変える戦略
* **誘導局所探索 (GLS):**
    * 行き詰まったら、その解が持っている「悪い特徴（例：長い辺）」に**ペナルティ（罰金）**を加算する。
    * 評価関数（地形）そのものを隆起させ、解をそこから押し出す。

---

## 第8章：ラグランジュヒューリスティクス
超難問に対する「アメとムチ」の上級テクニック。

### 8.1 アルゴリズムの流れ
1.  **ラグランジュ緩和:**
    * 「絶対に守れ」という厳しい制約を取り払う。
    * 代わりに「違反したら罰金（ラグランジュ乗数）」を目的関数に加える。これで問題が簡単になる。
2.  **劣勾配法 (Subgradient Method):**
    * 罰金が高すぎると誰も使わない、安すぎると違反だらけになる。
    * 最適な「罰金の相場」を探す調整プロセス。
3.  **ヒューリスティクス:**
    * 緩和問題で出た答え（ほぼ良い線いってるが、少しルール違反している）をベースにする。
    * 違反部分だけを貪欲法などで手直しして、最終的な答えを作る。

---

## 第9章：ツール・ソルバー対応マップ

| 解決したい課題 | 推奨ツール/ソルバー | 解説 |
| :--- | :--- | :--- |
| **数式で書ける計画**<br>(生産計画, シフト作成) | **Gurobi**, **CPLEX**<br>(無料ならCBC, SCIP) | 整数計画法(MIP)に特化した商用ソルバーが圧倒的に速い。モデリングは Python (PuLP, GurobiPy) で行う。 |
| **配送ルート (VRP)** | **Google OR-Tools**<br>**LocalSolver** | 制約（時間枠、積載量）が複雑なため、MIPソルバーよりメタヒューリスティクス特化型エンジンが強い。 |
| **ネットワーク分析**<br>(最短路, 重要度) | **NetworkX** | Pythonライブラリ。グラフ理論のアルゴリズムが網羅されている。大規模データには向かない。 |
| **独自の複雑なルール**<br>(パズル, 特殊な配置) | **自作 (Python + Numba)** | 定型化できない問題は、局所探索やSAを自力で実装する。高速化テクニック（差分計算など）が必須。 |

---
